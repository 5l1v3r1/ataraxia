#!/bin/bash

main() {
	if [ -z "$LINUX" ]; then
		LINUX="linux"
	fi

	STAGE="$BUILD/stage"

	rm -rf "$STAGE"
	mkdir -p "$STAGE"

	packages="base-files netbase linux-headers musl tzdata man-pages musl-tools gettext-tiny zlib file ncurses readline m4 bison flex bc gmp mpfr mpc binutils gcc \
		ccache bzip2 pkgconf cracklib pam attr acl libcap shadow pcre grep mksh bash libtool gdbm db expat perl nettle libressl ca-certificates autoconf automake xz lzip lz4 zstd \
		libarchive kmod libuargp libelf perp busybox coreutils mawk hostname mandoc dialog pigz libmnl libnftnl libnfnetlink libnetfilter_conntrack libnl libpcap iptables iproute2 \
		kbd make patch nano libcap-ng util-linux ubase sinit e2fsprogs hwids gperf eudev popt rsync libssh2 c-ares libev nghttp2 curl oniguruma jq neko $LINUX"

	neko install -c "$BUILD"/target.config -r "$STAGE" $packages

	case $BARCH in
		amd64|i386|ppc64le|ppc64)
			TTYS="1 2 3 4 5 6"
			;;
		arm64|armhf|armel|mips64|mips64el|mips|mipsel|riscv64|riscv32)
			TTYS="1 S0 AMA0 USB0"
			;;
	esac

	for tty in $TTYS; do
		chmod +t "$PKG"/etc/perp/tty${tty}
	done

	pushd "$STAGE"
		bsdtar -c --zstd -f "$BUILD"/ataraxialinux-$BARCH.tar.zst .
	popd
}
