# Description: Desktop-independent graphical login manager for X11
# URL:         http://sourceforge.net/projects/slim.berlios/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  cmake ninja pam libpng libjpeg-turbo libxmu libxft libxrandr xorg-fonts
# Section:     utils

name=slim
version=1.3.6
release=2
backup=('etc/slim.conf'
	'etc/slimlock.conf'
	'etc/logrotate.d/slim'
	'etc/pam.d/slim')
source=("https://downloads.sourceforge.net/project/slim.berlios/$name-$version.tar.gz")

build() {
	cd "$SRC"/$name-$version
	patch -Np1 -i "$STUFF"/slim/no-slimlock.patch
	patch -Np1 -i "$STUFF"/slim/libslim-underlinking.patch
	patch -Np1 -i "$STUFF"/slim/slim-freetype-dirs.patch
	patch -Np1 -i "$STUFF"/slim/snprintf.patch
	patch -Np1 -i "$STUFF"/slim/musl-includes.patch

	sed -i -e 's|#xserver_arguments.*|xserver_arguments -nolisten tcp vt07|' \
		-e 's|/var/run/slim.lock|/var/lock/slim.lock|' \
		-e 's|halt_cmd.*|halt_cmd            /sbin/poweroff|'\
		-e 's|reboot_cmd.*|reboot_cmd          /sbin/reboot|'\
		slim.conf

	mkdir -p build
	cd build
	cmake "$SRC"/$name-$version \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_SKIP_RPATH=ON \
		-DUSE_CONSOLEKIT=no \
		-DUSE_PAM=ON \
		-Wno-dev -G Ninja
	ninja
	DESTDIR="$PKG" ninja install

	for rc in slim; do
		install -Dm755 "$STUFF"/perpd/$rc "$PKG"/etc/perp/$rc/rc.main
		install -Dm755 "$STUFF"/perpd/log "$PKG"/etc/perp/$rc/rc.log
	done

	install -Dm644 "$STUFF"/slim/logrotate "$PKG"/etc/logrotate.d/slim
	install -Dm644 "$STUFF"/pam.d/slim "$PKG"/etc/pam.d/slim
	install -Dm644 "$STUFF"/pam.d/slimlock "$PKG"/etc/pam.d/slimlock

	rm -rf "$PKG"/lib
}
