# Description: D-Bus interface for user account query and manipulation
# URL:         https://gitlab.freedesktop.org/accountsservice/accountsservice
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  meson gobject-introspection libgcrypt polkit
# Section:     admin

name=accountservice
version=0.6.55
release=1
source=("https://www.freedesktop.org/software/$name/$name-$version.tar.xz")

build() {
	cd "$SRC"/$name-$version
	patch -Np1 -i "$STUFF"/accountsservice/musl-fgetspent_r.patch
	patch -Np1 -i "$STUFF"/accountsservice/musl-wtmp.patch

	mkdir -p build
	cd build
	ataraxia-meson "$SRC"/$name-$version \
		-Dadmin_group=wheel \
		-Ddocbook=false \
		-Delogind=false \
		-Dsystemd=false
	ninja
	DESTDIR="$PKG" ninja install

	for svc in accounts-daemon; do
		install -Dm0755 "$STUFF"/svc/$svc-run "$PKG"/etc/service/$svc/run
	done

	mkdir -p "$PKG"/etc/polkit-1/rules.d/
cat > "$PKG"/etc/polkit-1/rules.d/40-adm.rules << "EOF"
polkit.addAdminRule(function(action, subject) {
   return ["unix-group:adm"];
   });
EOF
}
