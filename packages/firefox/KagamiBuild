# Description: Standalone web browser from mozilla.org
# URL:         https://www.mozilla.org/firefox/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  autoconf2.13 python cbindgen clang nasm yasm ffmpeg gtk gtk2 libnotify nodejs nss alsa-lib zip unzip icu libevent libwebp sqlite startup-notification
# Section:     net

name=firefox
version=68.1.0
release=3
options=('~emptydirs' '~ccache')
source=("https://archive.mozilla.org/pub/$name/releases/${version}esr/source/$name-${version}esr.source.tar.xz"
	"https://archive.mozilla.org/pub/$name/releases/${version}esr/linux-x86_64/xpi/ru.xpi"
	"https://archive.mozilla.org/pub/$name/releases/${version}esr/linux-x86_64/xpi/ja.xpi")
noextract=("ru.xpi"
           "ja.xpi")

build() {
	export LDFLAGS="-Wl,-rpath,/usr/lib/firefox"

	cd "$SRC"/$name-$version
	patch -Np1 -i "$STUFF"/firefox/fix-fortify-system-wrappers.patch
	patch -Np1 -i "$STUFF"/firefox/fix-seccomp-bpf.patch
	patch -Np1 -i "$STUFF"/firefox/fix-toolkit.patch
	patch -Np1 -i "$STUFF"/firefox/fix-tools.patch
	patch -Np1 -i "$STUFF"/firefox/mallinfo.patch
	patch -Np1 -i "$STUFF"/firefox/disable-moz-stackwalk.patch
	patch -Np1 -i "$STUFF"/firefox/fix-musl.patch
	patch -Np1 -i "$STUFF"/firefox/fix-webrtc-glibcisms.patch
	patch -Np1 -i "$STUFF"/firefox/fix-sandbox-membarrier.patch

	cp "$STUFF"/firefox/stab.h toolkit/crashreporter/google-breakpad/src/

	cat > mozconfig <<-EOF
		ac_add_options --disable-dbus
		ac_add_options --disable-necko-wifi
		ac_add_options --disable-startup-notification
		ac_add_options --disable-pulseaudio
		ac_add_options --enable-alsa
		ac_add_options --enable-av1
		ac_add_options --enable-ffmpeg
		ac_add_options --disable-debug-symbols
		ac_add_options --prefix=/usr
		ac_add_options --enable-application=browser
		ac_add_options --disable-elf-hack
		ac_add_options --disable-gold
		ac_add_options --disable-jemalloc
		ac_add_options --disable-profiling
		ac_add_options --enable-release
		ac_add_options --enable-rust-simd
		ac_add_options --enable-hardening
		ac_add_options --disable-crashreporter
		ac_add_options --disable-updater
		ac_add_options --disable-tests
		ac_add_options --enable-system-ffi
		ac_add_options --enable-system-pixman
		ac_add_options --enable-system-sqlite
		ac_add_options --enable-startup-notification
		ac_add_options --with-system-bz2
		ac_add_options --with-system-icu
		ac_add_options --with-system-libevent
		ac_add_options --with-system-nspr
		ac_add_options --with-system-nss
		ac_add_options --with-system-pixman
		ac_add_options --with-system-png
		ac_add_options --with-system-webp
		ac_add_options --with-system-zlib
		ac_add_options --disable-official-branding
		ac_add_options --with-branding=browser/branding/unofficial
		ac_add_options --enable-update-channel=release
		ac_add_options --disable-gconf
		ac_add_options --host=$XTARGET
		ac_add_options --target=$XTARGET
	EOF

	./mach build -j$(nproc)
	DESTDIR="$PKG" ./mach install

	mkdir -p "$PKG"/usr/lib/firefox/browser/defaults/preferences/
	cat > "$PKG"/usr/lib/firefox/browser/defaults/preferences/vendor.js <<-EOF
		pref("browser.shell.checkDefaultBrowser", false);
		pref("toolkit.telemetry.enabled", false);
		pref("datareporting.healthreport.service.enabled", false);
		pref("datareporting.healthreport.uploadEnabled", false);
		pref("network.websocket.enabled", false);
		pref("dom.event.clipboardevents.enabled", false);
		pref("dom.battery.enabled", false);
		pref("browser.send_pings", false);
		pref("webgl.disabled", true);
		pref("browser.pocket.enabled", false);
		pref("media.peerconnection.enabled", false);
		pref("loop.enabled", false);
		pref("media.eme.enabled", false);
		pref("media.gmp-eme-adobe.enabled", false);
		pref("browser.beacen.enabled", false);
		pref("geo.enabled", false);
		pref("geo.wifi.logging.enabled", false);
		pref("geo.wifi.uri", "");
		pref("browser.safebrowsing.enabled", false);
		pref("browser.safebrowsing.downloads.enabled", false);
		pref("browser.safebrowsing.malware.enabled", false);
		pref("social.directories", "");
		pref("social.whitelist", "");
		pref("social.manifest.facebook", "");
		pref("social.remote-install.enabled", false);
		pref("social.toast-notifications.enabled", false);
		pref("device.sensors.enabled", false);
		pref("camera.control.face_detection.enabled", false);
		pref("camera.control.autofocus_moving_callback.enabled", false);
		pref("privacy.trackingprotection.enabled", true);
		pref("privacy.donottrackheader.enabled", true);
		pref("network.http.speculative-parallel-limit", 0);
	EOF

	for i in 16 32 48 64 128; do
		install -Dm644 browser/branding/unofficial/default$i.png "$PKG"/usr/share/icons/hicolor/${i}x${i}/apps/firefox.png
	done

	mkdir -p "$PKG"/usr/bin/
	ln -sf /usr/lib/firefox/firefox "$PKG"/usr/bin/firefox

	mkdir -p "$PKG"/usr/share/applications/
	cat > "$PKG"/usr/share/applications/firefox.desktop <<-EOF
		[Desktop Entry]
		Encoding=UTF-8
		Name=Nightly
		Comment=Browse the World Wide Web
		GenericName=Web Browser
		Exec=firefox %u
		Terminal=false
		Type=Application
		Icon=firefox
		Categories=GNOME;GTK;Network;WebBrowser;
		MimeType=application/xhtml+xml;text/xml;application/xhtml+xml;application/vnd.mozilla.xul+xml;text/mml;x-scheme-handler/http;x-scheme-handler/https;
		StartupNotify=true
	EOF

	for a in ru ja; do
		install -Dm644 "$SRC"/${a}.xpi "$PKG"/usr/lib/firefox/browser/extensions/langpack-${a}@firefox.mozilla.org.xpi
	done
}
