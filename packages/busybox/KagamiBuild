# Description: Size optimized toolbox of many common UNIX utilities
# URL:         https://www.busybox.net/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Section:     utils

name=busybox
version=1.31.0
release=2
options=('bootstrap')
source=("http://busybox.net/downloads/$name-$version.tar.bz2")


build_busybox_standard() {
	cp "$STUFF"/busybox/config .config

	if [ "$USEBOOTSTRAP" = "yes" ]; then
		make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} EXTRA_CFLAGS="$CFLAGS"
		make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} EXTRA_CFLAGS="$CFLAGS" busybox.links
	else
		make ARCH=$XKARCH EXTRA_CFLAGS="$CFLAGS"
		make ARCH=$XKARCH EXTRA_CFLAGS="$CFLAGS" busybox.links
	fi

	install -D busybox "$PKG"/usr/bin/busybox

	chmod 4755 "$PKG"/usr/bin/busybox

	for applet in `cat busybox.links|sed 's|^.*/||'`; do ln -s busybox "$PKG"/usr/bin/$applet || true; done

	mkdir -p "$PKG"/etc/service "$PKG"/var/service

	for svc in acpid crond inted ntpd watchdog tty{1,2,3,4,5,6,S0,AMA0,USB0}; do
		install -Dm0755 "$STUFF"/svc/$svc-run "$PKG"/etc/service/$svc/run
	done

	for svc in tty{1,2,3,4,5,6,S0,AMA0,USB0}; do
		ln -sf /etc/service/$svc "$PKG"/var/service/$svc
	done

	${CROSS_COMPILE}cc $CFLAGS -static "$STUFF"/busybox/pr.c "$STUFF"/busybox/egetopt.c "$STUFF"/busybox/strtonum.c -o "$PKG"/usr/bin/pr
	${CROSS_COMPILE}cc $CFLAGS -static "$STUFF"/busybox/apply.c -o "$PKG"/usr/bin/what
	${CROSS_COMPILE}cc $CFLAGS -static "$STUFF"/busybox/what.c -o "$PKG"/usr/bin/apply
	${CROSS_COMPILE}cc $CFLAGS -static "$STUFF"/busybox/who.c -o "$PKG"/usr/bin/who
	${CROSS_COMPILE}cc $CFLAGS -static "$STUFF"/busybox/xinstall.c "$STUFF"/busybox/strtonum.c "$STUFF"/busybox/setmode.c "$STUFF"/busybox/pwcache.c "$STUFF"/busybox/vwarnc.c "$STUFF"/busybox/verrc.c "$STUFF"/busybox/warnc.c "$STUFF"/busybox/errc.c "$STUFF"/busybox/getprogname.c "$STUFF"/busybox/reallocarray.c "$STUFF"/busybox/strtofflags.c -o "$PKG"/usr/bin/install

	ln -sf install "$PKG"/usr/bin/xinstall

	for a in apply.1 install.1 pr.1 what.1 who.1; do
		install -Dm0644 "$STUFF"/busybox/$a "$PKG"/usr/share/man/man1/$a
	done

	ln -sf install.1 "$PKG"/usr/share/man/man1/xinstall.1
}

build_busybox_embedded() {
	make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} EXTRA_CFLAGS="$CFLAGS" defconfig
	sed -i "s|.*CONFIG_STATIC.*|CONFIG_STATIC=y|" .config

	make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} EXTRA_CFLAGS="$CFLAGS"
	make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} EXTRA_CFLAGS="$CFLAGS" busybox.links

	install -D busybox "$PKG"/usr/bin/busybox

	chmod 4755 "$PKG"/usr/bin/busybox

	for applet in `cat busybox.links|sed 's|^.*/||'`; do ln -s busybox "$PKG"/usr/bin/$applet || true; done

	mkdir -p "$PKG"/etc/service "$PKG"/var/service

	for svc in acpid crond inted ntpd watchdog tty{1,2,3,4,5,6,S0,AMA0,USB0}; do
		install -Dm0755 "$STUFF"/svc/$svc-run "$PKG"/etc/service/$svc/run
	done

	for svc in tty{1,2,3,4,5,6,S0,AMA0,USB0}; do
		ln -sf /etc/service/$svc "$PKG"/var/service/$svc
	done

	mkdir -p "$PKG"/usr/share/udhcpc
	cp "$SRC"/$name-$version/examples/udhcp/simple.script "$PKG"/usr/share/udhcpc/default.script
	chmod +x "$PKG"/usr/share/udhcpc/default.script
}

build() {
	case $BARCH in
		amd64)
			export XKARCH="x86_64"
			;;
		i386)
			export XKARCH="i386"
			;;
		arm64)
			export XKARCH="arm64"
			;;
		armhf|armel)
			export XKARCH="arm"
			;;
		mips64|mips64el|mips|mipsel)
			export XKARCH="mips"
			;;
		m68k)
			export XKARCH="m68k"
			;;
		riscv64|riscv32)
			export XKARCH="riscv"
			;;
		*)
			echo "Architecture is not set or is not supported by Ataraxia Linux"
			exit 1
	esac

	cd "$SRC"/$name-$version
	make mrproper

	if [ "$EMBEDDED" = "1" ]; then
		build_busybox_embedded
	else
		build_busybox_standard
	fi
}
