# Description: Small and simple packages manager for Ataraxia Linux
# URL:         https://github.com/ataraxialinux/kagami
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  bash libarchive curl

name=kagami
version=496
release=4
options=('bootstrap')
backup=('etc/kagami.conf')
source=("https://github.com/ataraxialinux/kagami/archive/$version.tar.gz")

build() {
	cd "$SRC"/$name-$version
	patch -Np1 -i "$STUFF"/kagami/7aa923853625add4c9fb6f6a3eb97e686f4d7331.patch
	patch -Np1 -i "$STUFF"/kagami/c20f9f988f6ce5cc296f482e3b49a31d194df881.patch
	patch -Np1 -i "$STUFF"/kagami/be9c60d75bd9594ee77d5803abb79ac5d56e623b.patch
	patch -Np1 -i "$STUFF"/kagami/ace33caa4f1723eb1604406aad96174d16ec65bb.patch
	patch -Np1 -i "$STUFF"/kagami/a8f0e0e2fdb9c45722934bfcdc19f9b8dad8b9b9.patch

	./build.sh -B
	./build.sh -I -P /usr -D "$PKG"

	mkdir -p "$PKG"/var/cache/kagami/{packages,sources}

	rm -rf "$PKG"/etc/kagami.conf

cat > "$PKG"/etc/kagami.conf << "EOF"
# Uncomment if you want parallel build or add certain options for 'make' or 'ninja'
#
# MKOPTS=""

# Options for build:
#
#  emptydirs - Leave empty directories
#  strip     - Remove debug information from binaries
#  makeflags - Enable parallel build
#  locales   - Leave localization files
#  docs      - Leave documentation files
#  ccache    - Enable ccache
#
# Add '~' before option name to disable certain option
#
OPTIONS=('emptydirs' 'strip' 'makeflags' '~locales' '~docs' 'ccache')

# Source and package destination
#
PKGDEST="/var/cache/kagami/packages"
SRCDEST="/var/cache/kagami/sources"

# Repositories
#
# REPOS=('/var/cache/ports/packages' '/tmp/community' '/home/localname/myrepo')
REPOS=('/usr/ports/packages')


# System variables
export BARCH="@BARCH@"

export XTARGET="@XTARGET@"
export BUILDFLAGS="--build=$XTARGET"
export TOOLFLAGS="$BUILDFLAGS"
export PERLFLAGS=

export CFLAGS="@CFLAGS@"
export CXXFLAGS="@CXXFLAGS@"

export STUFF="/usr/ports/stuff"
EOF

	sed -i "$PKG"/etc/kagami.conf \
		-e "s|@BARCH[@]|$BARCH|g" \
		-e "s|@XTARGET[@]|$XTARGET|g" \
		-e "s|@CFLAGS[@]|$CFLAGS|g" \
		-e "s|@CXXFLAGS[@]|$CXXFLAGS|g"

	install -Dm0755 "$STUFF"/kagami/reposync "$PKG"/usr/bin/reposync
}
