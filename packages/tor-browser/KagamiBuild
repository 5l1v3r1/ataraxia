# Description: Anonymous Web Browser
# URL:         https://www.torproject.org/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  autoconf2.13 python cbindgen clang nasm yasm git ffmpeg gtk3 libnotify node nss alsa-lib zip unzip icu libevent libwebp sqlite startup-notification dbus-glib tor
# Section:     web

name=tor-browser
version=9.0.5
gitver=68.5.0esr-9.0-1-build2
torlauncherver=0.2.20.5
commitver=0ea73b63c364bac4f2a2156add3d46e1fc4d8120
release=1
options=('~emptydirs' '~ccache')
source=("https://dist.torproject.org/torbrowser/$version/src-firefox-tor-browser-$gitver.tar.xz"
	"https://dist.torproject.org/torbrowser/9.0.4/src-tor-launcher-$torlauncherver.tar.xz"
	"https://git.torproject.org/builders/tor-browser-build.git")

build() {
	export LDFLAGS="-Wl,-rpath,/usr/lib/firefox"

	cd "$SRC"/firefox-tor-browser-$gitver
	patch -Np1 -i "$STUFF"/tor-browser/fix-fortify-system-wrappers.patch
	patch -Np1 -i "$STUFF"/tor-browser/fix-seccomp-bpf.patch
	patch -Np1 -i "$STUFF"/tor-browser/fix-toolkit.patch
	patch -Np1 -i "$STUFF"/tor-browser/fix-tools.patch
	patch -Np1 -i "$STUFF"/tor-browser/mallinfo.patch
	patch -Np1 -i "$STUFF"/tor-browser/disable-moz-stackwalk.patch
	patch -Np1 -i "$STUFF"/tor-browser/fix-musl.patch
	patch -Np1 -i "$STUFF"/tor-browser/fix-webrtc-glibcisms.patch
	patch -Np1 -i "$STUFF"/tor-browser/fix-sandbox-membarrier.patch

	mkdir -p browser/extensions/tor-launcher
	cp -av "$SRC"/tor-launcher-$torlauncherver/* browser/extensions/tor-launcher/

	cp "$STUFF"/tor-browser/stab.h toolkit/crashreporter/google-breakpad/src/

	sed -i 's|--enable-tor-browser-update|--disable-tor-browser-update|' .mozconfig
	cat > mozconfig-ataraxia <<-EOF
		ac_add_options --with-tor-browser-version=$version
		ac_add_options --with-distribution-id=org.torproject
		ac_add_options --enable-update-channel=release
		ac_add_options --enable-bundled-fonts
		ac_add_options --enable-dbus
		ac_add_options --disable-necko-wifi
		ac_add_options --disable-startup-notification
		ac_add_options --disable-pulseaudio
		ac_add_options --enable-alsa
		ac_add_options --enable-av1
		ac_add_options --enable-ffmpeg
		ac_add_options --disable-debug-symbols
		ac_add_options --prefix=/usr
		ac_add_options --disable-elf-hack
		ac_add_options --disable-gold
		ac_add_options --disable-jemalloc
		ac_add_options --disable-profiling
		ac_add_options --enable-rust-simd
		ac_add_options --enable-hardening
		ac_add_options --disable-updater
		ac_add_options --enable-system-ffi
		ac_add_options --enable-system-pixman
		ac_add_options --enable-system-sqlite
		ac_add_options --enable-startup-notification
		ac_add_options --with-system-bz2
		ac_add_options --with-system-icu
		ac_add_options --with-system-libevent
		ac_add_options --with-system-nspr
		ac_add_options --with-system-nss
		ac_add_options --with-system-pixman
		ac_add_options --with-system-png
		ac_add_options --with-system-webp
		ac_add_options --with-system-zlib
		ac_add_options --disable-gconf
		ac_add_options --host=$XTARGET
		ac_add_options --target=$XTARGET
	EOF
	echo "" >> .mozconfig
	cat mozconfig-ataraxia >> .mozconfig

	./mach build -j$(nproc)
	DESTDIR="$PKG" ./mach install

	for i in 128 16 256 32 48 512 64; do
		install -Dm644 browser/branding/official/default$i.png "$PKG"/usr/share/icons/hicolor/${i}x${i}/apps/tor-browser.png
	done

	mkdir -p "$PKG"/usr/bin/
	ln -sf /usr/lib/firefox/firefox "$PKG"/usr/bin/firefox

	mkdir -p "$PKG"/usr/share/applications/
	cat > "$PKG"/usr/share/applications/tor-browser.desktop <<-EOF
		[Desktop Entry]
		Encoding=UTF-8
		Name=Tor Browser
		Comment=Anonymous Web Browser
		GenericName=Anonymous Web Browser
		Exec=firefox %u
		Terminal=false
		Type=Application
		Icon=tor-browser
		Categories=GNOME;GTK;Network;WebBrowser;
		StartupNotify=true
		StartupWMClass=Tor Browser
	EOF

	mkdir -p "$PKG"/usr/lib/firefox/TorBrowser/Tor

	cd "$SRC"/tor-browser-build.git
	git checkout $commitver
	cp -av projects/tor-browser/Bundle-Data/linux/* "$PKG"/usr/lib/firefox/TorBrowser/

	ln -sf /usr/bin/tor "$PKG"/usr/lib/firefox/TorBrowser/Tor/tor

	chmod -R 777 "$PKG"/usr/lib/firefox/TorBrowser/Data/Browser
}
