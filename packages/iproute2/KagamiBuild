# Description: IP Routing Utilities
# URL:         https://git.kernel.org/pub/scm/network/iproute2/iproute2.git
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  libcap iptables

name=iproute2
version=5.1.0
release=1
backup=('etc/iproute2/ematch_map'
	'etc/iproute2/rt_dsfield'
	'etc/iproute2/rt_protos'
	'etc/iproute2/rt_realms'
	'etc/iproute2/rt_scopes'
	'etc/iproute2/rt_tables')
options=('bootstrap')
source=("https://www.kernel.org/pub/linux/utils/net/$name/$name-$version.tar.xz")

build() {
	export CFLAGS="-I$STUFF/include $CFLAGS"

	cd "$SRC"/$name-$version
	patch -Np1 -i "$STUFF"/iproute2/0001-devlink-fix-libc-and-kernel-headers-collision.patch
	patch -Np1 -i "$STUFF"/iproute2/musl-fixes.patch

	sed -i '/^TARGETS=/s: arpd : :' misc/Makefile
	sed -i 's:/usr/local:/usr:' tc/m_ipt.c include/iptables.h
	sed -i -e 's:=/share:=/usr/share:' \
		-e 's:-Werror::' Makefile
	sed -e 's/^check_elf$/echo "no"/' -i configure

	./configure $BUILDFLAGS \
		--prefix=/usr
	make
	make DESTDIR="$PKG" SBINDIR="/usr/bin" install
}
