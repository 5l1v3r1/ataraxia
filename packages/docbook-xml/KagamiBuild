# Description:	A widely used XML scheme for writing documentation and help
# URL:		https://www.oasis-open.org/docbook/
# Maintainer:	protonesso, nagakamira at gmail dot com
# Depends on:	libxml2
# Section:	text

name=docbook-xml
version=4.5
release=2
source=("http://distfiles.gentoo.org/distfiles/$name-$version.zip")

build() {
	install -d -m755 "$PKG"/usr/share/xml/docbook/xml-dtd-$version
	install -d -m755 "$PKG"/etc/xml

	cd "$SRC"
	chown -R root:root .
	cp -af docbook.cat *.dtd ent/ *.mod "$PKG"/usr/share/xml/docbook/xml-dtd-$version

	xmlcatalog --noout --create "$PKG"/etc/xml/docbook

	xmlcatalog --noout --add "public" \
		"-//OASIS//DTD DocBook XML V$version//EN" \
		"http://www.oasis-open.org/docbook/xml/$version/docbookx.dtd" \
		"$PKG"/etc/xml/docbook
	xmlcatalog --noout --add "public" \
		"-//OASIS//DTD DocBook XML CALS Table Model V$version//EN" \
		"file:///usr/share/xml/docbook/xml-dtd-$version/calstblx.dtd" \
		"$PKG"/etc/xml/docbook
	xmlcatalog --noout --add "public" \
		"-//OASIS//DTD XML Exchange Table Model 19990315//EN" \
		"file:///usr/share/xml/docbook/xml-dtd-$version/soextblx.dtd" \
		"$PKG"/etc/xml/docbook
	xmlcatalog --noout --add "public" \
		"-//OASIS//ELEMENTS DocBook XML Information Pool V$version//EN" \
		"file:///usr/share/xml/docbook/xml-dtd-$version/dbpoolx.mod" \
		"$PKG"/etc/xml/docbook
	xmlcatalog --noout --add "public" \
		"-//OASIS//ELEMENTS DocBook XML Document Hierarchy V$version//EN" \
		"file:///usr/share/xml/docbook/xml-dtd-$version/dbhierx.mod" \
		"$PKG"/etc/xml/docbook
	xmlcatalog --noout --add "public" \
		"-//OASIS//ELEMENTS DocBook XML HTML Tables V$version//EN" \
		"file:///usr/share/xml/docbook/xml-dtd-$version/htmltblx.mod" \
		"$PKG"/etc/xml/docbook
	xmlcatalog --noout --add "public" \
		"-//OASIS//ENTITIES DocBook XML Notations V$version//EN" \
		"file:///usr/share/xml/docbook/xml-dtd-$version/dbnotnx.mod" \
		"$PKG"/etc/xml/docbook
	xmlcatalog --noout --add "public" \
		"-//OASIS//ENTITIES DocBook XML Character Entities V$version//EN" \
		"file:///usr/share/xml/docbook/xml-dtd-$version/dbcentx.mod" \
		/etc/xml/docbook
	xmlcata"$PKG"log --noout --add "public" \
		"-//OASIS//ENTITIES DocBook XML Additional General Entities V$version//EN" \
		"file:///usr/share/xml/docbook/xml-dtd-$version/dbgenent.mod" \
		"$PKG"/etc/xml/docbook
	xmlcatalog --noout --add "rewriteSystem" \
		"http://www.oasis-open.org/docbook/xml/$version" \
		"file:///usr/share/xml/docbook/xml-dtd-$version" \
		"$PKG"/etc/xml/docbook
	xmlcatalog --noout --add "rewriteURI" \
		"http://www.oasis-open.org/docbook/xml/$version" \
		"file:///usr/share/xml/docbook/xml-dtd-$version" \
		"$PKG"/etc/xml/docbook

	xmlcatalog --noout --add "delegatePublic" \
		"-//OASIS//ENTITIES DocBook XML" \
		"file:///etc/xml/docbook" \
		"$PKG"/etc/xml/catalog
	xmlcatalog --noout --add "delegatePublic" \
		"-//OASIS//DTD DocBook XML" \
		"file:///etc/xml/docbook" \
		"$PKG"/etc/xml/catalog
	xmlcatalog --noout --add "delegateSystem" \
		"http://www.oasis-open.org/docbook/" \
		"file:///etc/xml/docbook" \
		"$PKG"/etc/xml/catalog
	xmlcatalog --noout --add "delegateURI" \
		"http://www.oasis-open.org/docbook/" \
		"file:///etc/xml/docbook" \
		"$PKG"/etc/xml/catalog

	xmlcatalog --noout --add "delegatePublic" \
		"-//OASIS//ENTITIES DocBook XML" \
		"file:///etc/xml/docbook" \
		"$PKG"/etc/xml/catalog &&
	xmlcatalog --noout --add "delegatePublic" \
		"-//OASIS//DTD DocBook XML" \
		"file:///etc/xml/docbook" \
		"$PKG"/etc/xml/catalog &&
	xmlcatalog --noout --add "delegateSystem" \
		"http://www.oasis-open.org/docbook/" \
		"file:///etc/xml/docbook" \
		"$PKG"/etc/xml/catalog &&
	xmlcatalog --noout --add "delegateURI" \
		"http://www.oasis-open.org/docbook/" \
		"file:///etc/xml/docbook" \
		"$PKG"/etc/xml/catalog

	for DTDVERSION in 4.1.2 4.2 4.3 4.4; do
		xmlcatalog --noout --add "public" \
		"-//OASIS//DTD DocBook XML V$DTDVERSION//EN" \
			"http://www.oasis-open.org/docbook/xml/$DTDVERSION/docbookx.dtd" \
			"$PKG"/etc/xml/docbook
		xmlcatalog --noout --add "rewriteSystem" \
			"http://www.oasis-open.org/docbook/xml/$DTDVERSION" \
			"file:///usr/share/xml/docbook/xml-dtd-$version" \
			"$PKG"/etc/xml/docbook
		xmlcatalog --noout --add "rewriteURI" \
			"http://www.oasis-open.org/docbook/xml/$DTDVERSION" \
			"file:///usr/share/xml/docbook/xml-dtd-$version" \
			"$PKG"/etc/xml/docbook
		xmlcatalog --noout --add "delegateSystem" \
			"http://www.oasis-open.org/docbook/xml/$DTDVERSION/" \
			"file:///etc/xml/docbook" \
			"$PKG"/etc/xml/catalog
		xmlcatalog --noout --add "delegateURI" \
			"http://www.oasis-open.org/docbook/xml/$DTDVERSION/" \
			"file:///etc/xml/docbook" \
			"$PKG"/etc/xml/catalog
	done

	find "$PKG" -type f -exec chmod -c a-x {} +
	chmod -Rc u=rwX,go=rX "$PKG"
}
