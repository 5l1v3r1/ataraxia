# Description: The Linux kernel
# URL:         https://www.kernel.org/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Priority:    required
# Section:     kernel

name=linux
version=5.4.22
hardenedver=5.4.22.a
case $version in
	*.*.*) kver=$version;;
	*.*) kver=$version.0;;
esac
release=1
options=('~strip' 'bootstrap' '~ccache')
source=("https://cdn.kernel.org/pub/linux/kernel/v5.x/$name-$version.tar.xz"
	"https://github.com/anthraxx/linux-hardened/releases/download/$hardenedver/linux-hardened-$hardenedver.patch")

yconfig() {
	while [ $# -ne 0 ]; do
		./scripts/config --enable $1
		shift 1
	done
}

mconfig() {
	while [ $# -ne 0 ]; do
		./scripts/config --module $1
		shift 1
	done
}

nconfig() {
	while [ $# -ne 0 ]; do
		./scripts/config --disable $1
		shift 1
	done
}

varconfig() {
	FUONE="$1"
	FUTWO="$2"

	./scripts/config --set-val "$FUONE" "$FUTWO"
}

strconfig() {
	FUONE="$1"
	FUTWO="$2"

	./scripts/config --set-str "$FUONE" "$FUTWO"
}

generate_config() {
	case $BARCH in
		x86_64|i586)
			SUBKARCH="x86"
			;;
		*)
			SUBKARCH="$XKARCH"
			;;
	esac

	case $BARCH in
		x86_64)
			export DEFCONFIG="x86_64_defconfig"
			;;
		i586)
			export DEFCONFIG="i386_defconfig"
			;;
		aarch64)
			export DEFCONFIG="defconfig"
			;;
		armv7hnl|armv7hl)
			export DEFCONFIG="multi_v7_defconfig"
			;;
		armv5tel)
			export DEFCONFIG="multi_v5_defconfig"
			;;
		mips64|mips64el|mips|mipsel)
			export DEFCONFIG="malta_defconfig"
			;;
		ppc64le)
			export DEFCONFIG="powernv_defconfig"
			;;
		ppc64)
			export DEFCONFIG="g5_defconfig"
			;;
		ppc)
			export DEFCONFIG="pmac32_defconfig"
			;;
		riscv64)
			export DEFCONFIG="defconfig"
			;;
		riscv32)
			export DEFCONFIG="rv32_defconfig"
			;;
		*)
			echo "Architecture is not set or is not supported by Ataraxia Linux"
			exit 1
	esac

	if [ "$CROSS" = "yes" ]; then
		make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} $DEFCONFIG
	else
		make ARCH=$XKARCH $DEFCONFIG
	fi

	case $BARCH in
		x86_64)
			yconfig 64BIT PCI SERIAL_8250 SERIAL_8250_CONSOLE RTC_CLASS IA32_EMULATION \
				EFI EFI_STUB EFI_MIXED EFI_VARS FB_EFI EFI_RUNTIME_MAP EFIVAR_FS \
				NUMA AMD_NUMA NODES_SPAN_OTHER_NODES NEED_MULTIPLE_NODES USE_PERCPU_NUMA_NODE_ID ACPI_NUMA \
				MICROCODE MICROCODE_EARLY MICROCODE_INTEL MICROCODE_AMD X86_PM_TIMER KVM_AMD_SEV
			nconfig NUMA_EMU XEN_DEBUG_FS
			mconfig KVM_INTEL KVM_AMD FB_HYPERV VBOXGUEST HYPERV HYPERV_UTILS \
				HYPERV_MOUSE HYPERV_NET HYPERV_BALLOON
			varconfig XEN_BALLOON_MEMORY_HOTPLUG_LIMIT 512
			varconfig NODES_SHIFT 6
			;;
		i586)
			yconfig M586 PCI SERIAL_8250 SERIAL_8250_CONSOLE RTC_CLASS \
				EFI EFI_STUB EFI_MIXED EFI_VARS FB_EFI EFI_RUNTIME_MAP EFIVAR_FS \
				MICROCODE MICROCODE_EARLY MICROCODE_INTEL MICROCODE_AMD X86_PM_TIMER KVM_AMD_SEV
			mconfig KVM_INTEL KVM_AMD FB_HYPERV VBOXGUEST HYPERV HYPERV_UTILS \
				HYPERV_MOUSE HYPERV_NET HYPERV_BALLOON
			nconfig M686
			;;
		mips64|mips64el|mips|mipsel)
			yconfig SERIAL_8250 SERIAL_8250_CONSOLE PCI NET_VENDOR_AMD PCNET32 POWER_RESET POWER_RESET_SYSCON
			;;
		riscv64|riscv32)
			yconfig RISCV_ISA_C RISCV_ISA_A FPU SIFIVE_PLIC
			;;
	esac

	case $BARCH in
		mips64|mips64el)
			nconfig CPU_MIPS32_R2
			nconfig 32BIT
			for archconf in CPU_MIPS64_R2 MIPS_O32_FP64_SUPPORT 64BIT MIPS32_O32 MIPS32_N32; do
				yconfig $archconf
			done
			;;
	esac

	case $BARCH in
		mip64|mips)
			sed -i -e 's:CONFIG_CPU_LITTLE_ENDIAN:CONFIG_CPU_BIG_ENDIAN:' .config
			;;
		mips64el|mipsel)
			sed -i -e 's:CONFIG_CPU_BIG_ENDIAN:CONFIG_CPU_LITTLE_ENDIAN:' .config
			;;
	esac

	# Laptop drivers
	case $BARCH in
		x86_64|i586)
			yconfig X86_PLATFORM_DEVICES INTEL_TURBO_MAX_3 INTEL_PMC_CORE THINKPAD_ACPI_ALSA_SUPPORT THINKPAD_ACPI_VIDEO THINKPAD_ACPI_HOTKEY_POLL \
				SONYPI_COMPAT DELL_SMBIOS_WMI DELL_SMBIOS_SMM
			mconfig ACER_WMI ACER_WIRELESS ACERHDF ALIENWARE_WMI ASUS_LAPTOP DCDBAS DELL_SMBIOS DELL_LAPTOP DELL_WMI DELL_WMI_DESCRIPTOR DELL_WMI_AIO \
				DELL_WMI_LED DELL_SMO8800 DELL_RBTN DELL_RBU FUJITSU_LAPTOP FUJITSU_TABLET AMILO_RFKILL GPD_POCKET_FAN HP_ACCEL HP_WIRELESS HP_WMI LG_LAPTOP \
				MSI_LAPTOP PANASONIC_LAPTOP COMPAL_LAPTOP SONY_LAPTOP IDEAPAD_LAPTOP THINKPAD_ACPI SENSORS_HDAPS INTEL_MENLOW EEEPC_LAPTOP ASUS_WMI ASUS_NB_WMI \
				EEEPC_WMI ASUS_WIRELESS ACPI_WMI WMI_BMOF INTEL_WMI_THUNDERBOLT XIAOMI_WMI MSI_WMI PEAQ_WMI TOPSTAR_LAPTOP ACPI_TOSHIBA TOSHIBA_BT_RFKILL TOSHIBA_HAPS \
				TOSHIBA_WMI ACPI_CMPC INTEL_CHT_INT33FE INTEL_INT0002_VGPIO INTEL_HID_EVENT INTEL_VBTN INTEL_IPS IBM_RTL SAMSUNG_LAPTOP MXM_WMI INTEL_OAKTRAIL SAMSUNG_Q10 \
				APPLE_GMUX INTEL_RST INTEL_SMARTCONNECT INTEL_PMC_IPC INTEL_BXTWC_PMIC_TMU SURFACE_PRO3_BUTTON SURFACE_3_BUTTON INTEL_PUNIT_IPC MLX_PLATFORM INTEL_CHTDC_TI_PWRBTN \
				I2C_MULTI_INSTANTIATE INTEL_ATOMISP2_PM HUAWEI_WMI PCENGINES_APU2
			nconfig THINKPAD_ACPI_DEBUGFACILITIES THINKPAD_ACPI_DEBUG THINKPAD_ACPI_UNSAFE_LEDS INTEL_TELEMETRY
			;;
	esac

	# Core
	yconfig SMP EARLY_PRINTK BINFMT_ELF BINFMT_SCRIPT NO_HZ HIGH_RES_TIMERS HZ_300 PREEMPT CC_OPTIMIZE_FOR_SIZE \
		HAVE_KERNEL_GZIP HAVE_KERNEL_BZIP2 HAVE_KERNEL_LZMA HAVE_KERNEL_XZ HAVE_KERNEL_LZO HAVE_KERNEL_LZ4 \
		RD_GZIP RD_BZIP2 RD_LZMA RD_XZ RD_LZO RD_LZ4 MAGIC_SYSRQ BCACHE_DEBUGBCACHE_CLOSURES_DEBUG \
		ZRAM_WRITEBACK KVM
	mconfig BCACHE ZRAM MOUSE_PS2
	nconfig EMBEDDED ZRAM_MEMORY_TRACKING MMC_DEBUG

	strconfig DEFAULT_HOSTNAME misaka-mikoto
	strconfig LOCALVERSION -ataraxia
	varconfig HZ 300

	# blk
	yconfig BLOCK BLK_DEV BLK_DEV_INITRD BLK_DEV_LOOP BLK_RQ_ALLOC_TIME BLK_DEV_BSG BLK_WBT BLK_WBT_SQ BLK_WBT_MQ BLK_CGROUP BLK_DEV_INTEGRITY \
		BLK_DEV_ZONED BLK_DEV_THROTTLING BLK_DEV_RAM VIRTIO_BLK BLK_DEV_SD BLK_DEV_SR CHR_DEV_SG BLK_DEV_MD BLK_DEV_DM_BUILTIN \
		BLK_DEV_3W_XXXX_RAI
	mconfig BLK_DEV_UMEM BLK_DEV_CRYPTOLOOP CHR_DEV_ST CHR_DEV_SCH BLK_DEV_DM BLK_DEV_PMEM

	# LVM, ISCSI, MDADM
	yconfig MD MD_LINEAR MD_AUTODETECT MD_RAID0 MD_RAID1 MD_RAID10 MD_RAID456 DM_UEVENT DM_VERITY_VERIFY_ROOTHASH_SIG DM_VERITY_FEC \
		FUSION FUSION_SPI FUSION_FC FUSION_SAS FUSION_CTL FUSION_LAN ISCSI_IBFT_FIND ISCSI_BOOT_SYSFS
	mconfig MD_MULTIPATH MD_FAULTY MD_CLUSTER DM_BIO_PRISON DM_PERSISTENT_DATA DM_UNSTRIPED DM_CRYPT DM_SNAPSHOT DM_THIN_PROVISIONING DM_CACHE \
		DM_CACHE_SMQ DM_WRITECACHE DM_ERA DM_CLONE DM_MIRROR DM_LOG_USERSPACE DM_RAID DM_ZERO DM_MULTIPATH DM_MULTIPATH_QL DM_MULTIPATH_ST \
		DM_DELAY DM_DUST DM_FLAKEY DM_VERITY DM_SWITCH DM_LOG_WRITES DM_INTEGRITY DM_ZONED CONFIG_TARGET_CORE TCM_IBLOCK TCM_FILEIO TCM_PSCSI \
		TCM_USER2 LOOPBACK_TARGET TCM_FC ISCSI_TARGET SCSI_TARGET_CXGB4 SBP_TARGET ISCSI_IBFT ISCSI_TCP
	nconfig DM_DEBUG_BLOCK_MANAGER_LOCKING FUSION_LOGGING
	varconfig FUSION_MAX_SGE 128

	# Crypto
	yconfig CRYPTO CRYPTO_ALGAPI CRYPTO_ALGAPI2 CRYPTO_AEAD CRYPTO_AEAD2 CRYPTO_BLKCIPHER CRYPTO_BLKCIPHER2 CRYPTO_HASH CRYPTO_HASH2 CRYPTO_RNG \
		CRYPTO_RNG2 CRYPTO_RNG_DEFAULT CRYPTO_AKCIPHER2 CRYPTO_AKCIPHER CRYPTO_KPP2 CRYPTO_KPP CRYPTO_ACOMP2 CRYPTO_MANAGER CRYPTO_MANAGER2 \
		CRYPTO_MANAGER_DISABLE_TESTS CRYPTO_GF128MUL CRYPTO_NULL CRYPTO_NULL2 CRYPTO_RSA CRYPTO_DH CRYPTO_GCM CRYPTO_LIB_SHA256 CRYPTO_SHA256 \
		CRYPTO_SHA512 CRYPTO_LIB_AES CRYPTO_AES CRYPTO_CTR CRYPTO_CTS CRYPTO_ECB CRYPTO_SEQIV CRYPTO_CBC CRYPTO_XTS CRYPTO_HMAC CRYPTO_CRCT10DIF \
		CRYPTO_GHASH CRYPTO_MD5 CRYPTO_SHA1 CRYPTO_DRBG_MENU CRYPTO_DRBG_HMAC CRYPTO_DRBG_HASH CRYPTO_DRBG_CTR CRYPTO_DRBG CRYPTO_JITTERENTROPY \
		CRYPTO_ZSTD CRYPTO_LZO CRYPTO_HASH_INFO CRYPTO_HW CRYPTO_DEV_SP_PSP CRYPTO_DEV_CCP_DEBUGFS CRYPTO_DEV_CCP CRYPTO_DEV_SP_CCP CHELSIO_IPSEC_INLINE \
		PKCS7_MESSAGE_PARSER SIGNED_PE_FILE_VERIFICATION X509_CERTIFICATE_PARSER ASYMMETRIC_KEY_TYPE ASYMMETRIC_PUBLIC_KEY_SUBTYPE
	mconfig CRYPTO_USER CRYPTO_PCRYPT CRYPTO_CRYPTD CRYPTO_AUTHENC CRYPTO_TEST CRYPTO_SIMD CRYPTO_ENGINE CRYPTO_ECC CRYPTO_ECDH CRYPTO_ECRDSA CRYPTO_CCM \
		CRYPTO_CHACHA20POLY1305 CRYPTO_AEGIS128 CRYPTO_ECHAINIV CRYPTO_CFB CRYPTO_LRW CRYPTO_OFB CRYPTO_PCBC CRYPTO_KEYWRAP CRYPTO_NHPOLY1305 CRYPTO_ADIANTUM \
		CRYPTO_ESSIV CRYPTO_CMAC CRYPTO_XCBC CRYPTO_VMAC CRYPTO_CRC32C CRYPTO_CRC32C_INTEL CRYPTO_CRC32 CRYPTO_CRC32_PCLMUL CRYPTO_XXHASH CRYPTO_CRCT10DIF_PCLMUL \
		CRYPTO_POLY1305 CRYPTO_MD4 CRYPTO_MICHAEL_MIC CRYPTO_RMD128 CRYPTO_RMD160 CRYPTO_RMD256 CRYPTO_RMD320 CRYPTO_SHA3 CRYPTO_SM3 CRYPTO_STREEBOG CRYPTO_TGR192 \
		CRYPTO_WP512 CRYPTO_GHASH_CLMUL_NI_INTEL CRYPTO_AES_TI CRYPTO_AES_NI_INTEL CRYPTO_ANUBIS CRYPTO_LIB_ARC4 CRYPTO_ARC4 CRYPTO_BLOWFISH CRYPTO_BLOWFISH_COMMON \
		CRYPTO_CAMELLIA CRYPTO_CAST_COMMON CRYPTO_CAST5 CRYPTO_CAST6 CRYPTO_LIB_DES CRYPTO_DES CRYPTO_FCRYPT CRYPTO_KHAZAD CRYPTO_SALSA20 CRYPTO_CHACHA20 CRYPTO_SEED \
		CRYPTO_SERPENT CRYPTO_SM4 CRYPTO_TEA CRYPTO_TWOFISH CRYPTO_TWOFISH_COMMON CRYPTO_DEFLATE CRYPTO_842 CRYPTO_LZ4 CRYPTO_LZ4HC CRYPTO_ANSI_CPRNG CRYPTO_USER_API \
		CRYPTO_USER_API_HASH CRYPTO_USER_API_SKCIPHER CRYPTO_USER_API_RNG CRYPTO_USER_API_AEAD CRYPTO_DEV_PADLOCK CRYPTO_DEV_PADLOCK_AES CRYPTO_DEV_PADLOCK_SHA \
		CRYPTO_DEV_ATMEL_I2C CRYPTO_DEV_ATMEL_ECC CRYPTO_DEV_ATMEL_SHA204A CRYPTO_DEV_CCP_DD CRYPTO_DEV_CCP_CRYPTO CRYPTO_DEV_QAT CRYPTO_DEV_QAT_DH895xCC CRYPTO_DEV_QAT_C3XXX \
		CRYPTO_DEV_QAT_C62X CRYPTO_DEV_QAT_DH895xCCVF CRYPTO_DEV_QAT_C3XXXVF CRYPTO_DEV_QAT_C62XVF CRYPTO_DEV_NITROX CRYPTO_DEV_NITROX_CNN55XX CRYPTO_DEV_CHELSIO \
		CRYPTO_DEV_CHELSIO_TLS CRYPTO_DEV_VIRTIO CRYPTO_DEV_SAFEXCEL CRYPTO_DEV_CCREE ASYMMETRIC_TPM_KEY_SUBTYPE PKCS8_PRIVATE_KEY_PARSER TPM_KEY_PARSER
	nconfig CRYPTO_STATS PKCS7_TEST_KEY

	# Platform specific crypto
	case $BARCH in
		x86_64|i586)
			mconfig CRYPTO_GLUE_HELPER_X86 CRYPTO_AEGIS128_AESNI_SSE2 CRYPTO_NHPOLY1305_SSE2 CRYPTO_SHA1_SSSE3 CRYPTO_SHA256_SSSE3 CRYPTO_SHA512_SSSE3 CRYPTO_NHPOLY1305_AVX2
			;;
	esac
	case $BARCH in
		x86_64)
			mconfig CRYPTO_TWOFISH_X86_64 CRYPTO_TWOFISH_X86_64_3WAY CRYPTO_TWOFISH_AVX_X86_64 CRYPTO_SERPENT_SSE2_X86_64 CRYPTO_SERPENT_AVX_X86_64 \
				CRYPTO_SERPENT_AVX2_X86_64 CRYPTO_CHACHA20_X86_64 CRYPTO_CAMELLIA_X86_64 CRYPTO_CAMELLIA_AESNI_AVX_X86_64 CRYPTO_CAMELLIA_AESNI_AVX2_X86_64 \
				CRYPTO_CAST5_AVX_X86_64 CRYPTO_CAST6_AVX_X86_64 CRYPTO_DES3_EDE_X86_64 CRYPTO_BLOWFISH_X86_64 CRYPTO_POLY1305_X86_64
			;;
		aarch64)
			yconfig ARM64_CRYPTO
			mconfig CRYPTO_SHA256_ARM64 CRYPTO_SHA512_ARM64 CRYPTO_SHA1_ARM64_CE CRYPTO_SHA2_ARM64_CE CRYPTO_SHA512_ARM64_CE \
				CRYPTO_SHA3_ARM64 CRYPTO_SM3_ARM64_CE CRYPTO_SM4_ARM64_CE CRYPTO_GHASH_ARM64_CE CRYPTO_CRCT10DIF_ARM64_CE \
				CRYPTO_AES_ARM64 CRYPTO_AES_ARM64_CE CRYPTO_AES_ARM64_CE_CCM  CRYPTO_AES_ARM64_CE_BLK CRYPTO_AES_ARM64_NEON_BLK
			;;
		armv7hnl|armv7hl|armv5tel)
			yconfig ARM_CRYPTO
			mconfig CRYPTO_AES_ARM64_BS CRYPTO_SHA1_ARM CRYPTO_SHA256_ARM CRYPTO_SHA512_ARM CRYPTO_AES_ARM CRYPTO_SHA1_ARM CRYPTO_AES_ARM
			nconfig CRYPTO_AES_ARM_CE CRYPTO_GHASH_ARM_CE CRYPTO_CRCT10DIF_ARM_CE CRYPTO_CRC32_ARM_CE CRYPTO_SHA1_ARM_CE CRYPTO_SHA2_ARM_CE
			;;
	esac

	# SCSI
	yconfig SCSI SCSI_DMA SCSI_MOD RAID_ATTRSSCSI_NETLINK SCSI_PROC_FS SCSI_LOWLEVEL SCSI_DPT_I2O SCSI_ADVANSYS SCSI_ARCMSR MEGARAID_NEWGEN MEGARAID_MM \
		MEGARAID_MAILBOX MEGARAID_SAS SCSI_MPT3SAS SCSI_MPT2SAS SCSI_UFS_BSG SCSI_HPTIOP SCSI_BUSLOGIC SCSI_FLASHPOINT SCSI_HPSA SCSI_3W_9XXX SCSI_3W_SAS \
		SCSI_ACARD SCSI_AHA1740 SCSI_AACRAID SCSI_AIC7XXX SCSI_AIC79XX SCSI_AIC94XX CONFIG_LIBFC LIBFCOE FCOE FCOE_FNIC SCSI_DH \
		SCSI_PM8001 SCSI_BFA_FC SCSI_QLOGIC_1280 SCSI_SYM53C8XX_MMIO SCSI_IPR SCSI_STEX SCSI_SYM53C8XX_2 SCSI_GDTH SCSI_ISCI SCSI_IPS SCSI_INITIO SCSI_INIA100 SCSI_DMX3191D
	mconfig SCSI_ENCLOSURE SCSI_BNX2X_FCOE BE2ISCSI SCSI_MVSAS ESAS2R SCSI_SMARTPQI SCSI_UFSHCD SCSI_UFSHCD_PCI SCSI_UFS_DWC_TC_PCI SCSI_UFSHCD_PLATFORM \
		SCSI_UFS_CDNS_PLATFORM SCSI_UFS_DWC_TC_PLATFORM SCSI_MYRB SCSI_MYRS MEGARAID_LEGACY SCSI_ESAS2R SCSI_MVUMI SCSI_CXGB3_ISCSI SCSI_CXGB4_ISCSI \
		SCSI_BNX2_ISCSI SCSI_PPA SCSI_IMM SCSI_QLA_FC TCM_QLA2XXX SCSI_QLA_ISCSI QEDI QEDF SCSI_LPFC SCSI_SIM710 SCSI_DC395x SCSI_AM53C974 SCSI_WD719X \
		SCSI_DEBUG SCSI_VIRTIO SCSI_CHELSIO_FCOE SCSI_DH_RDAC SCSI_DH_HP_SW SCSI_DH_EMC SCSI_DH_ALUA
	nconfig SCSI_CONSTANTS SCSI_LOGGING SCSI_SCAN_ASYNC AIC94XX_DEBUG SCSI_MVSAS_DEBUG SCSI_MVSAS_TASKLET AIC79XX_REG_PRETTY_PRINT AIC79XX_DEBUG_ENABLE \
		AIC7XXX_REG_PRETTY_PRINT AIC7XXX_DEBUG_ENABLE SCSI_LPFC_DEBUG_FS TCM_QLA2XXX_DEBU SCSI_IZIP_EPP16 SCSI_IZIP_SLOW_CTR SCSI_IPR_TRACE \
		SCSI_IPR_DUMP SCSI_SNIC_DEBUG_FS SCSI_FDOMAIN_PCI
	varconfig AIC79XX_CMDS_PER_DEVICE 32
	varconfig AIC79XX_RESET_DELAY_MS 5000
	varconfig AIC79XX_DEBUG_MASK 0
	varconfig AIC7XXX_CMDS_PER_DEVICE 32
	varconfig AIC7XXX_RESET_DELAY_MS 5000
	varconfig AIC7XXX_DEBUG_MASK 0
	varconfig SCSI_MPT2SAS_MAX_SGE 128
	varconfig SCSI_MPT3SAS_MAX_SGE 128
	varconfig SCSI_SYM53C8XX_DMA_ADDRESSING_MODE 1
	varconfig SCSI_SYM53C8XX_DEFAULT_TAGS 16
	varconfig SCSI_SYM53C8XX_MAX_TAGS 64

	# Platform specific SCSI
	case $BARCH in
		x86_64|i586)
			yconfig VMWARE_PVSCSI XEN_SCSI_FRONTEND HYPERV_STORAGE
			;;
	esac

	# SATA, IDE
	yconfig ATA ATA_VERBOSE_ERROR ATA_ACPI SATA_PMP SATA_AHCI SATA_AHCI_PLATFORM SATA_INIC162X SATA_ACARD_AHCI SATA_SIL24 ATA_SFF PDC_ADMA SATA_QSTOR SATA_SX4 \
		ATA_BMDMA ATA_PIIX SATA_DWC_OLD_DMA SATA_MV SATA_NV SATA_PROMISE SATA_SIL SATA_SIS SATA_SVW SATA_ULI SATA_VIA SATA_VITESSE PATA_ALI PATA_AMD PATA_ARTOP \
		PATA_ATIIXP PATA_ATP867X PATA_CMD64X PATA_CYPRESS PATA_EFAR PATA_HPT366 PATA_HPT37X PATA_HPT3X2N PATA_HPT3X3 PATA_HPT3X3_DMA PATA_IT8213 PATA_IT821X \
		PATA_JMICRON PATA_MARVELL PATA_NETCELL PATA_NINJA32 PATA_NS87415 PATA_OLDPIIX PATA_OPTIDMA PATA_RADISYS PATA_RDC PATA_SCH PATA_SERVERWORKS PATA_SIL680 \
		PATA_SIS PATA_TOSHIBA PATA_TRIFLEX PATA_VIA PATA_WINBOND PATA_CMD640_PCI PATA_MPIIX PATA_NS87410 PATA_OPTI PATA_RZ1000 ATA_GENERIC PATA_ACPI PATA_LEGACY
	mconfig PATA_PCMCIA PATA_PDC2027X PATA_PDC_OLD SATA_DWC
	nconfig ATA_PLATFORM SATA_DWC_DEBUG SATA_ZPODD
	varconfig SATA_MOBILE_LPM_POLICY 3

	# NVME
	yconfig NVME_CORE NVME_MULTIPATH
	mconfig NVME_FABRICS NVME_RDMA NVME_FC NVME_TCP NVME_TARGET NVME_TARGET_LOOP NVME_TARGET_RDMA NVME_TARGET_FC NVME_TARGET_FCLOOP NVME_TARGET_TCP

	# SHDCI
	yconfig MMC_SDHCI MMC_SDHCI_PCI MMC_SDHCI_ACPI MMC_SDHCI_PLTFM MMC_RICOH_MMC MMC_SDHCI_IO_ACCESSORS MMC_REALTEK_PCI MMC_REALTEK_USB MMC_CQHCI MMC_TOSHIBA_PCI \
		MMC_MTK MMC_SDHCI_XENON MMC_TIFM_SD MMC_SPI MMC_SDRICOH_CS MMC_CB710 MMC_VIA_SDMMC
	mconfig MMC_SDHCI_F_SDH30 MMC_WBSD MMC_ALCOR MMC_VUB300 MMC_USHC MMC_USDHI6ROL0 MEMSTICK
	nconfig MEMSTICK_DEBUG

	# Platform specific SDHCI
	case $BARCH in
		aarch64|armv7hnl|armv7hl|armv5tel)
			yconfig MMC_ARMMMCI MMC_QCOM_DML MMC_SDHCI_OF_ASPEED MMC_SDHCI_OF_AT91 MMC_SDHCI_CADENCE MMC_SDHCI_ESDHC_IMX \
				MMC_SDHCI_TEGRA MMC_SDHCI_PXAV3 MMC_SDHCI_F_SDH30 MMC_SUNXI MMC_DW MMC_DW_PLTFM MMC_DW_EXYNOS MMC_DW_K3 MMC_DW_PCI MMC_DW_ROCKCHIP
			nconfig MMC_DW_BLUEFIELD MMC_DW_HI3798CV200
			;;
	esac

	# USB
	yconfig USB_UAS USB_SUPPORT USB_COMMON USB_ARCH_HAS_HCD USB USB_ANNOUNCE_NEW_DEVICES \
		USB_C67X00_HCD USB_XHCI_HCD USB_XHCI_DBGCAP USB_XHCI_PCI USB_XHCI_PLATFORM USB_EHCI_HCD USB_EHCI_ROOT_HUB_TT \
		USB_EHCI_TT_NEWSCHED USB_EHCI_PCI USB_EHCI_HCD_PLATFORM USB_OXU210HP_HCD USB_ISP116X_HCD USB_FOTG210_HCD USB_OHCI_HCD \
		USB_OHCI_HCD_PCI USB_OHCI_HCD_SSB USB_OHCI_HCD_PLATFORM USB_UHCI_HCD USB_U132_HCD USB_SL811_HCD USB_SL811_CS USB_R8A66597_HCD \
		USB_WHCI_HCD USB_HWA_HCD USB_HCD_SSB USB_DWCOTG USB_PHY USB_MXS_PHY AMLOGIC_USB USB_DWC_OTG_HCD \
		USB_HOST_ELECT_TEST USB_DEFAULT_PERSIST UCSI MFD_RTSX_USB MMC_REALTEK_USB MEMSTICK_REALTEK_USB USB_MASS_STORAGE \
		U_SERIAL_CONSOLE USB_GADGET MEDIA_USB_SUPPORT INTEL_ISH_HID USB_OHCI_LITTLE_ENDIAN USB_SUPPORT USB_COMMON \
		USB_ARCH_HAS_HCD USB_PCI USB_DEFAULT_PERSIST USB_OTG USB_LEDS_TRIGGER_USBPORT USB_MON USB_WUSB USB_WUSB_CBAF \
		USB_CDNS3 USB_CDNS3_PCI_WRAP USB_CDNS3_GADGET USB_CDNS3_HOST
	mconfig USB_G_SERIAL USB_PRINTER
	nconfig USB_ACM USB_MON USB_HCD_TEST_MODE USB_HCD_BCMA USB_SL811_HCD_ISO USB_WUSB_CBAF_DEBUG \
		USB_OTG_WHITELIST USB_OTG_BLACKLIST_HUB USB_OTG_FSM USB_DYNAMIC_MINORS

	# USB storage drivers
	mconfig USB_STORAGE USB_STORAGE_REALTEK REALTEK_AUTOPM USB_STORAGE_DATAFAB USB_STORAGE_FREECOM USB_STORAGE_ISD200 \
		USB_STORAGE_USBAT USB_STORAGE_SDDR09 USB_STORAGE_SDDR55 USB_STORAGE_JUMPSHOT USB_STORAGE_ALAUDA \
		USB_STORAGE_ONETOUCH USB_STORAGE_KARMA USB_STORAGE_CYPRESS_ATACB USB_STORAGE_ENE_UB6250
	yconfig REALTEK_AUTOPM

	# USB serial drivers
	mconfig USB_USS720 USB_SERIAL USB_SERIAL_GENERIC USB_SERIAL_SIMPLE USB_SERIAL_AIRCABLE USB_SERIAL_ARK3116 USB_SERIAL_BELKIN \
		USB_SERIAL_CH341 USB_SERIAL_WHITEHEAT USB_SERIAL_DIGI_ACCELEPORT USB_SERIAL_CP210X USB_SERIAL_CYPRESS_M8 \
		USB_SERIAL_EMPEG USB_SERIAL_FTDI_SIO USB_SERIAL_VISOR USB_SERIAL_IPAQ USB_SERIAL_IR USB_SERIAL_EDGEPORT \
		USB_SERIAL_EDGEPORT_TI USB_SERIAL_F81232 USB_SERIAL_F8153X USB_SERIAL_GARMIN USB_SERIAL_IPW USB_SERIAL_IUU \
		USB_SERIAL_KEYSPAN_PDA USB_SERIAL_KEYSPAN USB_SERIAL_KLSI USB_SERIAL_KOBIL_SCT USB_SERIAL_MCT_U232 \
		USB_SERIAL_METRO USB_SERIAL_MOS7720 USB_SERIAL_MOS7715_PARPORT USB_SERIAL_MOS7840 USB_SERIAL_MXUPORT \
		USB_SERIAL_NAVMAN USB_SERIAL_PL2303 USB_SERIAL_OTI6858 USB_SERIAL_QCAUX USB_SERIAL_QUALCOMM \
		USB_SERIAL_SPCP8X5 USB_SERIAL_SAFE USB_SERIAL_SIERRAWIRELESS USB_SERIAL_SYMBO USB_SERIAL_TI \
		USB_SERIAL_CYBERJACK USB_SERIAL_XIRCOM USB_SERIAL_WWAN USB_SERIAL_OPTION USB_SERIAL_OMNINET \
		USB_SERIAL_OPTICON USB_SERIAL_XSENS_MT USB_SERIAL_WISHBONE USB_SERIAL_SSU100 USB_SERIAL_QT2 \
		USB_SERIAL_UPD78F0730 USB_SERIAL_DEBUG

	# USB misc
	mconfig USB_EMI62 USB_EMI26 USB_ADUTUX USB_SEVSEG USB_RIO500 _USB_LEGOTOWER USB_LCD USB_CYPRESS_CY7C63 USB_CYTHERM USB_IDMOUSE \
		USB_FTDI_ELAN USB_APPLEDISPLAY USB_SISUSBVGA USB_SISUSBVGA_CON USB_LD USB_TRANCEVIBRATOR USB_IOWARRIOR USB_TEST \
		USB_EHSET_TEST_FIXTURE USB_ISIGHTFW USB_YUREX USB_EZUSB_FX2 USB_HUB_USB251XB USB_HSIC_USB3503 USB_HSIC_USB4604 \
		USB_LINK_LAYER_TEST USB_CHAOSKEY USB_ATM USB_SPEEDTOUCH USB_CXACRU USB_UEAGLEATM USB_XUSBATM \
		SB_GR_UDC USB_R8A66597 USB_PXA27X USB_MV_UDC USB_MV_U3D USB_SNP_CORE USB_SNP_UDC_PLAT USB_M66592 \
		USB_BDC_UDC USB_BDC_PCI USB_AMD5536UDC USB_NET2272 USB_NET2272_DMA USB_NET2280 USB_GOKU \
		USB_EG20T USB_GADGET_XILINX USB_DUMMY_HCD USB_LIBCOMPOSITE USB_F_ACM USB_F_SS_LB \
		USB_U_SERIAL USB_U_ETHER USB_U_AUDIO USB_F_SERIAL USB_F_OBEX USB_F_NCM USB_F_ECM \
		USB_F_PHONET USB_F_EEM USB_F_SUBSET USB_F_RNDIS USB_F_MASS_STORAGE USB_F_FS \
		USB_F_UAC1 USB_F_UAC1_LEGACY USB_F_UAC2 USB_F_UVC USB_F_MIDI USB_F_HID USB_F_PRINTER \
		USB_F_TCM USB_CONFIGFS USB_ZERO USB_AUDIO USB_ETH USB_ETH_RNDIS USB_ETH_EEM \
		USB_G_NCM USB_GADGETFS USB_FUNCTIONFS USB_FUNCTIONFS_ETH USB_FUNCTIONFS_RNDIS \
		USB_FUNCTIONFS_GENERIC USB_MASS_STORAGE USB_GADGET_TARGET USB_G_SERIAL \
		USB_MIDI_GADGET USB_G_PRINTER USB_CDC_COMPOSITE USB_G_NOKIA USB_G_ACM_MS USB_G_MULTI \
		USB_G_MULTI_RNDIS USB_G_MULTI_CDC USB_G_HID USB_G_DBGP USB_G_DBGP_SERIAL \
		USB_G_WEBCAM UCSI_CCG UCSI_ACPI USB_ROLES_INTEL_XHCI USB_LED_TRIG USB_ULPI_BUS \
		UWB UWB_HWA UWB_WHCI UWB_I1480U PWRSEQ_EMMC PWRSEQ_SD8787 PWRSEQ_SIMPLE USB_MDC800 USB_MICROTEK \
		USBIP_CORE USB_MUSB_HDRC USB_DWC3 USB_DWC2 USB_CHIPIDEA USB_ISP1760
	yconfig USB_CONFIGFS_SERIAL USB_CONFIGFS_ACM USB_CONFIGFS_OBEX USB_CONFIGFS_NCM USB_CONFIGFS_ECM \
		USB_CONFIGFS_ECM_SUBSET USB_CONFIGFS_RNDIS USB_CONFIGFS_EEM USB_CONFIGFS_PHONET USB_CONFIGFS_MASS_STORAGE \
		USB_CONFIGFS_F_LB_SS USB_CONFIGFS_F_FS USB_CONFIGFS_F_UAC1 USB_CONFIGFS_F_UAC1_LEGACY USB_CONFIGFS_F_UAC2 \
		USB_CONFIGFS_F_MIDI USB_CONFIGFS_F_HID USB_CONFIGFS_F_UVC USB_CONFIGFS_F_PRINTER USB_CONFIGFS_F_TCM \
		USB_ROLE_SWITCH
	nconfig USB_G_DBGP_PRINTK GADGET_UAC1 USB_GADGET_UAC1 USBIP_DEBUG

	# TypeC support
	yconfig TYPEC TYPEC_TCPM TYPEC_TCPCI TYPEC_RT1711H TYPEC_FUSB302 TYPEC_WCOVE TYPEC_UCSI UCSI_CCG UCSI_ACPI
	mconfig TYPEC_TPS6598X TYPEC_MUX_PI3USB30532 TYPEC_DP_ALTMODE TYPEC_NVIDIA_ALTMODE

	# Thunderbolt support (x86)
	case $BARCH in
		x86_64|i586)
			yconfig THUNDERBOLT
			mconfig THUNDERBOLT_NET INTEL_WMI_THUNDERBOLT
			;;
	esac

	# IEEE 1394 support (x86 and ppc)
	case $BARCH in
		x86_64|i586|ppc64le|ppc64|ppc)
			mconfig FIREWIRE FIREWIRE_OHCI FIREWIRE_SBP2 FIREWIRE_NET FIREWIRE_NOSY
			;;
	esac

	if [ "$CROSS" = "yes" ]; then
		yes '' | make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} oldconfig
	else
		yes '' | make ARCH=$XKARCH oldconfig
	fi
}

build() {
	case $BARCH in
		x86_64)
			export XKARCH="x86_64"
			export IMAGELOC="arch/x86/boot/bzImage"
			;;
		i586)
			export XKARCH="i386"
			export IMAGELOC="arch/x86/boot/bzImage"
			;;
		aarch64)
			export XKARCH="arm64"
			export IMAGELOC="arch/arm64/boot/Image"
			;;
		armv7hnl|armv7hl|armv5tel)
			export XKARCH="arm"
			export IMAGELOC="arch/arm/boot/zImage"
			;;
		mips64|mips64el|mips|mipsel)
			export XKARCH="mips"
			export IMAGELOC="vmlinux"
			;;
		ppc64le|ppc64|ppc)
			export XKARCH="powerpc"
			export IMAGELOC="vmlinux"
			;;
		riscv64|riscv32)
			export XKARCH="riscv"
			export IMAGELOC="arch/riscv/boot/Image"
			;;
		*)
			echo "Architecture is not set or is not supported by Ataraxia Linux"
			exit 1
	esac

	cd "$SRC"/$name-$version
	patch -Np1 -i "$SRC"/linux-hardened-$hardenedver.patch
	patch -Np1 -i "$STUFF"/linux/1-2-lib-Add-support-for-ZSTD-compressed-kernel.diff
	patch -Np1 -i "$STUFF"/linux/2-2-x86-Add-support-for-ZSTD-compressed-kernel.diff
	patch -Np1 -i "$STUFF"/linux/wireguard.patch
	patch -Np1 -i "$STUFF"/linux/blk.patch
	patch -Np1 -i "$STUFF"/linux/scsi.patch

	sed -i 's|return elevator_get(q, "mq-deadline", false);|return elevator_get(q, "bfq", false);|' block/elevator.c

	case $BARCH in
		riscv64|riscv32)
			patch -Np1 -i "$STUFF"/linux/riscv.patch
			;;
	esac

	unset LDFLAGS
	make mrproper

	generate_config

	if [ "$USEBOOTSTRAP" = "yes" ]; then
		yes '' | make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE}
	else
		yes '' | make ARCH=$XKARCH
	fi

	if [ "$USEBOOTSTRAP" = "yes" ]; then
		make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} INSTALL_MOD_STRIP=1 INSTALL_MOD_PATH="$PKG"/usr modules_install
	else
		make ARCH=$XKARCH INSTALL_MOD_STRIP=1 INSTALL_MOD_PATH="$PKG"/usr modules_install
	fi

	depmod -a -b "$PKG"/usr ${kver}-ataraxia

	case $BARCH in
		aarch64|armv7hnl|armv7hl|armv5tel)
			if [ "$USEBOOTSTRAP" = "yes" ]; then
				make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} INSTALL_DTBS_PATH="$PKG"/boot/dtbs dtbs_install
			else
				make ARCH=$XKARCH INSTALL_DTBS_PATH="$PKG"/boot/dtbs dtbs_install
			fi
			;;
	esac

	mkdir -p "$PKG"/boot
	cp "$IMAGELOC" "$PKG"/boot/vmlinuz-${version}-ataraxia
	cp .config "$PKG"/boot/config-${version}-ataraxia

	for a in vmlinuz config; do
		ln -sf ${a}-${version}-ataraxia "$PKG"/boot/$a
	done

	rm -rf "$PKG"/usr/lib/modules/${kver}-ataraxia/build
	rm -rf "$PKG"/usr/lib/modules/${kver}-ataraxia/source
}
