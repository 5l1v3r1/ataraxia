# Description: An object-oriented language for quick and easy programming
# URL:         http://www.ruby-lang.org/en/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  zlib gmp gdbm db readline libressl libffi yaml
# Section:     interpreters

name=ruby
version=2.6.4
jsonver=2.1.0
release=2
options=('~emptydirs')
source=("https://cache.ruby-lang.org/pub/ruby/${version:0:3}/ruby-${version}.tar.xz"
	"https://github.com/flori/json/archive/v${jsonver}.tar.gz")

build() {
	cd "$SRC"/json-${jsonver}
	patch -Np1 -i "$STUFF"/ruby/json-libre.patch
	rm -rf json.gemspec ext lib/json/ext*

	cd "$SRC"/$name-$version
	patch -Np1 -i "$STUFF"/ruby/remove-json-ext.patch
	patch -Np1 -i "$STUFF"/ruby/add-json_pure.patch
	patch -Np1 -i "$STUFF"/ruby/rubygems-avoid-platform-specific-gems.patch

	rm -rf ext/json test/json
	cp -a "$SRC"/json-${jsonver}/lib/* lib/
	cp -a "$SRC"/json-${jsonver}/json_pure.gemspec lib/json/
	cp -a "$SRC"/json-${jsonver}/tests test/json

	export CFLAGS="${CFLAGS/-fomit-frame-pointer}"
	export CXXFLAGS="${CXXFLAGS/-fomit-frame-pointer}"
	export CFLAGS="$CFLAGS -fno-omit-frame-pointer -fno-strict-aliasing"
	export CPPFLAGS="$CPPFLAGS -fno-omit-frame-pointer -fno-strict-aliasing"

	export INSTALL=install

	export ac_cv_func_isnan=yes
	export ac_cv_func_isinf=yes

	./configure $BUILDFLAGS \
		--prefix=/usr \
		--libexecdir=/usr/lib/ruby \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--sharedstatedir=/var/lib \
		--with-dbm-type=gdbm_compat \
		--enable-pthread \
		--enable-shared \
		--disable-install-doc \
		--disable-install-rdoc \
		--disable-install-capi \
		--disable-rpath
	make
	make DESTDIR="$PKG" install
}
